# TODOリスト: Google Cloud Platformインフラストラクチャ

## 🏗️ **フェーズ 1: 基本プロジェクト設定と認証**

#### ⬜ タスク 1: リポジトリと基本設定
- [ ] GCPディレクトリ作成: `pose-est-infra/gcp/`
- [ ] 基本ファイル作成: README.md, .gitignore, SECURITY.md
- [ ] Terraformバージョン固定: `versions.tf` 作成
- [ ] Terraformバックエンド設定: Cloud Storageバケット準備

#### ⬜ タスク 2: GCP認証設定
- [ ] GCPサービスアカウント作成と権限設定
  - 必要な権限: Project Owner, Cloud Run Admin, Storage Admin
- [ ] GitHub Secrets設定
  - `GCP_SA_KEY`, `GCP_PROJECT_ID`, `GCP_REGION`
- [ ] ローカル認証設定: `gcloud auth` と環境変数設定

#### ⬜ タスク 3: CI/CD基本パイプライン作成
- [ ] GitHub Actions基本ワークフロー作成
- [ ] Terraform Planワークフロー作成（PR時自動実行）
- [ ] セキュリティスキャンワークフロー作成

### 🏛️ **フェーズ 2: GCPプロジェクト基盤構築**

#### ⬜ タスク 4: GCPプロジェクト設定
- [ ] Terraformモジュール: `modules/gcp-project`
- [ ] GCPプロジェクト作成:
  - 開発: `pose-est-dev`
  - ステージング: `pose-est-staging` 
  - 本番: `pose-est-production`
- [ ] 必須APIの有効化:
  - Cloud Run API, Cloud Build API, Artifact Registry API
  - Secret Manager API, Cloud Storage API, IAM API
  - Monitoring API, Logging API
- [ ] リージョン設定: asia-northeast1 (東京)
- [ ] 予算アラート設定: 環境別に月間$20アラート

#### ⬜ タスク 5: ネットワーク基盤構築
- [ ] Terraformモジュール: `modules/networking`
- [ ] VPCネットワーク作成: `pose-est-vpc`
- [ ] サブネット設定:
  - `asia-northeast1` リージョンのサブネット
  - プライベートIP範囲の割り当て
- [ ] Cloud NAT設定（プライベートCloud Run用）
- [ ] ファイアウォールルール基本設定
- [ ] VPC Service Controls設定（セキュリティ境界）

#### ⬜ タスク 6: IAMとサービスアカウント設定
- [ ] Terraformモジュール: `modules/iam`
- [ ] サービスアカウント作成:
  - `cloud-run-sa` (Cloud Run実行用)
  - `cloud-build-sa` (Cloud Build実行用)
  - `github-actions-sa` (GitHub Actions実行用)
- [ ] IAMロール割り当て（最小権限の原則）
- [ ] カスタムIAMロール作成（必要に応じて）

### 🐳 **フェーズ 3: コンテナレジストリとビルド環境**

#### ⬜ タスク 7: Artifact Registry設定
- [ ] Terraformモジュール: `modules/artifact-registry`
- [ ] Dockerリポジトリ作成: `pose-est-backend`
- [ ] リポジトリ設定:
  - フォーマット: DOCKER
  - ロケーション: asia-northeast1
- [ ] リポジトリ権限設定:
  - Cloud Buildサービスアカウントへのアクセス許可
  - Cloud Runサービスアカウントへのアクセス許可
- [ ] ライフサイクルポリシー: 未使用イメージの自動削除
- [ ] 脆弱性スキャン設定: イメージスキャンの有効化

#### ⬜ タスク 8: Cloud Build設定
- [ ] Cloud Buildトリガー作成:
  - メインブランチプッシュ時トリガー
  - タグプッシュ時トリガー（本番デプロイ用）
- [ ] ビルド設定ファイル作成: `cloudbuild/backend-build.yaml`
  - Dockerビルドステップ
  - ユニットテスト実行ステップ
  - 脆弱性スキャンステップ
  - Artifact Registryへのプッシュステップ
- [ ] ビルドキャッシュ設定: ビルド時間短縮のためのキャッシュ
- [ ] ビルド通知設定: ビルド失敗時のSlack通知

#### ⬜ タスク 9: シークレット管理設定
- [ ] Secret Managerシークレット作成:
  - `BACKEND_API_KEYS`: API認証キー
  - `CLOUDFLARE_API_TOKEN`: Cloudflare連携用（DNS更新用）
  - `DATABASE_URL`（将来用）: DB接続情報
- [ ] シークレットバージョン管理ポリシー設定
- [ ] アクセス権限設定:
  - Cloud Runサービスアカウントへの権限付与
  - Cloud Buildサービスアカウントへの権限付与
- [ ] 自動ローテーションポリシー設定（将来対応）

### ☁️ **フェーズ 4: Cloud Runバックエンド環境構築**

#### ⬜ タスク 10: Cloud Runサービス基本設定
- [ ] Terraformモジュール: `modules/cloud-run`
- [ ] Cloud Runサービス作成: `pose-est-backend-{env}`
- [ ] コンテナ設定:
  - イメージソース: Artifact Registry (`pose-est-backend`)
  - ポート: 8080 (FastAPIデフォルト)
  - 環境変数: Secret Managerから注入
  - ヘルスチェックパス: `/health`
- [ ] リソース制限:
  - CPU: 1-2コア
  - メモリ: 1-4GB
  - 最大インスタンス数: 10
  - 最小インスタンス数: 0 (開発環境), 1 (本番)

#### ⬜ タスク 11: 自動スケーリング設定
- [ ] スケーリングポリシー定義:
  - CPU使用率: 60%ターゲット
  - リクエスト数: 100リクエスト/インスタンス
  - 最大同時リクエスト: 80
- [ ] コールドスタート対策:
  - 最小インスタンス数調整（本番環境）
  - コンテナインスタンスウォームアップ設定
- [ ] スケールダウン設定:
  - アイドルタイムアウト: 5分
  - スケールダウン遅延設定

#### ⬜ タスク 12: ネットワークとセキュリティ設定
- [ ] プライベートエンドポイント設定（VPC接続）
- [ ] Cloud Armor設定（DDoS保護）
- [ ] SSL証明書管理（マネージドSSL）
- [ ] カスタムドメイン準備: `api.kenken-pose-est.com`（Cloudflare連携用）
- [ ] CORS設定: Cloudflareドメインのみ許可
- [ ] サービスメッシュ設定（将来対応）

### 📦 **フェーズ 5: ストレージとデータ管理**

#### ⬜ タスク 13: Cloud Storage設定
- [ ] Terraformモジュール: `modules/cloud-storage`
- [ ] バケット作成: `pose-est-videos-{env}`
- [ ] バケット設定:
  - ロケーション: asia-northeast1
  - ストレージクラス: Standard
  - 公開レベル: オブジェクト単位（署名付きURL）
  - ユニフォームバケットレベルアクセス: 有効
- [ ] ライフサイクルポリシー:
  - 処理済み動画: 30日間保持
  - 未処理動画: 7日間保持
  - 削除済みオブジェクト: 90日後に完全削除

#### ⬜ タスク 14: アクセス制御と署名付きURL
- [ ] IAM権限設定:
  - Cloud Runサービスアカウントへのストレージオブジェクト作成権限
  - 署名付きURL発行権限
- [ ] CORS設定: Cloudflareドメインからのアクセス許可
- [ ] 署名付きURLテンプレート作成
- [ ] 一時アクセストークン発行ロジック（Cloud Run内実装）

#### ⬜ タスク 15: バックアップとディザスタリカバリ
- [ ] オブジェクトバージョニング有効化
- [ ] オブジェクトライフサイクル管理設定
- [ ] クロスリージョンレプリケーション設定（将来対応）
- [ ] バックアップポリシー定義
- [ ] リストア手順ドキュメント作成

### 📊 **フェーズ 6: 監視とアラート設定**

#### ⬜ タスク 16: Cloud Monitoring設定
- [ ] Terraformモジュール: `modules/monitoring`
- [ ] カスタムダッシュボード作成:
  - Cloud Runメトリクス（応答時間、エラー率、CPU使用率）
  - Cloud Storageメトリクス（使用量、オペレーション数）
  - コストメトリクス（プロジェクト別コスト）
  - ビジネスKPIダッシュボード
- [ ] アラートポリシー設定:
  - Cloud Runエラー率 > 1%
  - Cloud Run応答時間（p95） > 3秒
  - Cloud Storage使用率 > 80%
  - Cloud Runインスタンス数 > 最大値の80%
- [ ] 通知チャンネル設定: Email, Slack, PagerDuty

#### ⬜ タスク 17: ロギングと分析設定
- [ ] Cloud Logging設定:
  - ログ保持期間: 30日（デフォルト）
  - 重要なログの長期保存設定
- [ ] ログベースメトリクス定義:
  - エラーログ数
  - ビジネストランザクション数
- [ ] 構造化ロギング設定: JSON形式でのログ出力
- [ ] ログルーター設定: BigQueryへのエクスポート（分析用）

#### ⬜ タスク 18: パフォーマンスモニタリング
- [ ] 稼働率チェック設定:
  - ヘルスチェックエンドポイント監視
  - マルチリージョンからのチェック（将来対応）
- [ ] プロファイリング設定: Cloud Profiler有効化
- [ ] トレーシング設定: Cloud Trace有効化
- [ ] デバッグ設定: Cloud Debugger有効化（開発環境）

### 🔄 **フェーズ 7: 完全なCI/CDパイプライン構築**

#### ⬜ タスク 19: バックエンドCI/CDパイプライン
- [ ] GitHub Actionsワークフロー: `backend-deploy.yml`
- [ ] ビルドステージ:
  - Dockerイメージビルド（Cloud Build連携）
  - ユニットテスト実行
  - セキュリティスキャン（Trivy）
  - イメージ脆弱性スキャン
- [ ] デプロイステージ:
  - Artifact Registryへのイメージプッシュ
  - Cloud Runへのデプロイ（環境別）
  - ブルーグリーンデプロイメント設定（本番環境）
- [ ] 検証ステージ:
  - API結合テスト
  - パフォーマンステスト（軽量）
  - ロールバック準備

#### ⬜ タスク 20: インフラCI/CDパイプライン
- [ ] GitHub Actionsワークフロー: `terraform-apply.yml`
- [ ] Planステージ:
  - Terraform初期化
  - 計画実行と出力
  - セキュリティスキャン（Checkov）
  - コスト見積もり
- [ ] Applyステージ（承認ベース）:
  - 環境別Terraform適用
  - 状態ファイル管理（Cloud Storage）
  - 状態ロック（Cloud Spanner）
- [ ] 検証ステージ:
  - インフラヘルスチェック
  - リソース作成確認
  - Cloudflare連携テスト

#### ⬜ タスク 21: データベースCI/CD（将来対応準備）
- [ ] データベースマイグレーションフロー設計
- [ ] データシード管理
- [ ] データベースバックアップ統合
- [ ] スキーマ変更の安全なデプロイ手順

### 🧪 **フェーズ 8: テストと検証**

#### ⬜ タスク 22: 環境テスト
- [ ] 開発環境構築とテスト
- [ ] ステージング環境構築とテスト
- [ ] 本番環境シミュレーション
- [ ] フェイルオーバーテスト（基本）
- [ ] ロールバックテスト

#### ⬜ タスク 23: セキュリティテスト
- [ ] 脆弱性スキャン: コンテナイメージ、依存関係
- [ ] ペネトレーションテスト: APIエンドポイント
- [ ] コンプライアンスチェック: CIS GCPベンチマーク
- [ ] シークレット漏洩チェック: Git履歴スキャン
- [ ] ネットワークセキュリティテスト: ポートスキャン

#### ⬜ タスク 24: パフォーマンステスト
- [ ] 負荷テスト: 想定ユーザー数でのテスト
- [ ] スケーリングテスト: 負荷時の自動スケーリング検証
- [ ] コールドスタートテスト: 0インスタンスからの起動時間
- [ ] エンドツーエンドレイテンシテスト
- [ ] データ処理パフォーマンステスト（動画処理）

### 🔗 **フェーズ 9: Cloudflare連携と統合**

#### ⬜ タスク 25: DNS連携設定
- [ ] Cloud Run URL出力設定（Cloudflare用）
- [ ] DNS更新自動化スクリプト作成
- [ ] ドメイン検証設定
- [ ] SSL証明書連携設定

#### ⬜ タスク 26: セキュリティ連携
- [ ] Cloudflare IP範囲からのアクセス制限
- [ ] WAF連携設定（Cloud Armor連携）
- [ ] DDoS保護連携
- [ ] セキュリティヘッダー連携

#### ⬜ タスク 27: モニタリング連携
- [ ] クロスプロバイダーモニタリング設定
- [ ] アラート連携（Cloudflare → GCP）
- [ ] ログ連携設定
- [ ] ダッシュボード統合

### 📚 **フェーズ 10: ドキュメントと運用準備**

#### ⬜ タスク 28: 技術ドキュメント
- [ ] アーキテクチャ図作成（GCP部分）
- [ ] デプロイ手順書作成
- [ ] トラブルシューティングガイド
- [ ] セキュリティ設定ガイド
- [ ] コスト管理ガイド

#### ⬜ タスク 29: 運用ドキュメント
- [ ] 監視ダッシュボード説明書
- [ ] アラート対応手順
- [ ] バックアップ/リストア手順
- [ ] 容量計画ガイド
- [ ] 障害対応ランブック

#### ⬜ タスク 30: 開発者向けドキュメント
- [ ] ローカル開発環境構築ガイド
- [ ] デバッグ手順書
- [ ] テスト実施ガイド
- [ ] コーディング規約（インフラコード）

#### ⬜ タスク 31: 最終検証と本番移行
- [ ] 本番環境最終テスト
- [ ] パフォーマンスベースライン設定
- [ ] セキュリティ最終レビュー
- [ ] 移行計画作成（段階的ロールアウト）
- [ ] ロールバック計画作成
- [ ] 本番移行実行と検証

---

## 各フェーズ完了基準

1. **コード品質**: Terraform fmt, tflint, checkov でエラーなし
2. **テスト**: すべての機能テストが正常に完了
3. **セキュリティ**: セキュリティスキャンで重大な脆弱性なし
4. **パフォーマンス**: パフォーマンステストが基準を満たす
5. **コスト見積もり**: 想定コストが予算範囲内
6. **ドキュメント**: 必要なドキュメントが作成済み

## 重要注意事項

1. **状態ファイル管理**: 
   - 開発/ステージング/本番で状態ファイルを分離
   - バックエンドはCloud Storage、状態ロックはCloud Spanner
   - 状態ファイルの定期的なバックアップ

2. **シークレット管理**:
   - 全てのシークレットはSecret Managerで管理
   - Terraform変数で直接シークレットを扱わない
   - シークレットの自動ローテーション計画

3. **Cloudflare連携**:
   - DNS設定はCloud Run作成後に実施
   - CORS設定は両環境で整合性を確保
   - 定期的な接続テストの実施

4. **コスト最適化**:
   - 常に無料枠を確認しながら設計
   - 使用量に応じたスケーリング設定
   - 不要リソースの定期的なクリーンアップ

5. **セキュリティ**:
   - 最小権限の原則を徹底
   - 定期的なセキュリティスキャンの実施
   - 監査ログの長期保存と定期的なレビュー

6. **バックアップとDR**:
   - 重要なデータの定期的なバックアップ
   - バックアップからのリストアテスト
   - 災害復旧計画の定期的な見直し
