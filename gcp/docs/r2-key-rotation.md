# R2 キーローテーションポリシー

Cloudflare R2 のアクセスキー (クレデンシャル) のローテーションに関する運用ポリシーです。

## 基本ポリシー

- **推奨頻度**: 90 日 (3 ヶ月) ごと
- **緊急時**: キーの流出が疑われる場合は、即時にローテーションを実施してください。

---

## ローテーション手順

### 1. 新しいキーの作成

Cloudflare ダッシュボードから新しい R2 API トークンを作成します。

- 権限: Object Read/Write
- 有効期限: 無期限 (または次回のローテーション時期まで)

### 2. シークレットの更新

`scripts/register-r2-secrets.sh` を使用して、Secret Manager (および GitHub Secrets) に新しいキーを登録します。

```bash
./scripts/register-r2-secrets.sh --env dev
# 新しいキーを入力
```

Secret Manager は新しいバージョンのシークレットを作成し、Cloud Run は自動的（または次回のインスタンス起動時）に最新バージョンを使用します。

### 3. 動作確認

新しいキーでアプリケーションが正常に動作することを確認します。

- 画像のアップロード
- 画像のダウンロード

### 4. 古いキーの無効化

数日間の監視期間（移行期間）を置いた後、Cloudflare ダッシュボードから古い API トークンを削除します。

---

## 緊急時対応 (Key Compromise)

1. **即時無効化**: Cloudflare ダッシュボードで漏洩したキーを削除または無効化します。(**注意**: アプリケーションは一時的に停止します)
2. **新キー発行**: 手順 1 に従って新しいキーを発行します。
3. **緊急デプロイ/更新**: 手順 2 を実施し、必要であれば Cloud Run サービスを再起動して新しいシークレットを即座に読み込ませます。
   ```bash
   gcloud run services update pose-est-backend-dev --region asia-northeast1 --force-new-revision
   ```
