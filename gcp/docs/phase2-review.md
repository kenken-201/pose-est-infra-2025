# フェーズ 2 レビュー: GCP プロジェクト基盤構築

## 1. 概要

本フェーズでは、姿勢推定アプリケーションのバックエンド API をホストするための **GCP インフラストラクチャの基盤 (Foundation)** を構築しました。
「世界最高水準」の品質を目指し、単にリソースを作成するだけでなく、**可観測性 (Observability)**、**開発者体験 (DX)**、**セキュリティ (Least Privilege)** の 3 つの軸で徹底的なリファクタリングを実施しました。

## 2. 達成事項

### ✅ タスク 4: GCP プロジェクト設定

- **モジュール化**: `modules/gcp-project` を作成し、必須 API の有効化と予算アラート設定をカプセル化。
- **コスト管理**: 月額 $20 の予算アラートを設定し、意図しない課金を防止。
- **安定性**: 依存サービス誤削除防止 (`disable_dependent_services = false`) とタイムアウト設定による堅牢化。

### ✅ タスク 5: ネットワーク基盤構築

- **モジュール化**: `modules/networking` を作成。
- **構成**:
  - VPC (`pose-est-vpc`) とサブネット (`asia-northeast1`) の作成。
  - **Cloud NAT (Manual IP)**: 固定 IP を使用した NAT を構成し、外部連携時の IP ホワイトリスト対応を容易化。
- **Observability**: `outputs.tf` を強化し、`self_link` などの詳細情報を出力。

### ✅ タスク 6: IAM とサービスアカウント設定

- **モジュール化**: `modules/iam` を作成。
- **役割分担**:
  - `cloud-run-sa`: ランタイム用（ログ出力、Secret Manager 参照）。
  - `cloud-build-sa`: CI/CD 用（ビルド、デプロイ）。
- **セキュリティ強化**:
  - **最小権限の原則**: 各 SA に必要最低限のロールのみを付与。
  - **Impersonation 制限**: Cloud Build SA が `roles/iam.serviceAccountUser` を持つ範囲を **Cloud Run SA リソースのみ** に限定。プロジェクトレベルのなりすまし権限を排除。

## 3. 品質とエンジニアリングのハイライト

### 🚀 Developer Experience (DX)

- **日本語コメントとドキュメント化**:
  - 全ての Terraform コードとスクリプトに、Cloudflare 側のスタイルに倣った詳細な日本語コメントとヘッダーを追加。
  - 目的と意図（Why）をコード内に記述し、属人化を排除。
- **高速な品質チェック**:
  - `check-quality.sh` を **並列実行 (Parallel Execution)** にリファクタリング。
  - `terraform validate`, `tflint`, `checkov` を同時に実行し、フィードバックループを短縮。

### 🛡️ セキュリティ・ファースト

- **Checkov 導入**: インフラコードの静的セキュリティ解析を CI/CD に先駆けてローカル開発フローに統合。
- **意図的なトレードオフの明記**:
  - 現時点での「プロジェクトレベルの権限付与」について、その理由（初期開発効率）と将来の改善方針（リソースレベルへの移行）をコメントとして明記。

## 4. 次のステップ (フェーズ 3)

基盤が整いました。次はアプリケーションをデプロイするための「パイプラインと保存場所」を構築します。

1.  **タスク 7: Artifact Registry 設定**
    - Docker イメージリポジトリの作成。
    - 脆弱性スキャン設定。
2.  **タスク 8: Cloud Build 設定**
    - バックエンドアプリのビルド、テスト、Registry へのプッシュを行う CI パイプラインの実装。
