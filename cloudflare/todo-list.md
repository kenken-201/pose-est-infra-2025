# TODOリスト: Cloudflareインフラストラクチャ

## 🏗️ **フェーズ 1: 基本プロジェクト設定と認証**

#### ⬜ タスク 1: リポジトリと基本設定
- [ ] Cloudflareディレクトリ作成: `pose-est-infra/cloudflare/`
- [ ] 基本ファイル作成: README.md, .gitignore, SECURITY.md
- [ ] Terraformバージョン固定: `versions.tf` 作成
- [ ] Terraformバックエンド設定: 適切な状態管理方法の決定

#### ⬜ タスク 2: Cloudflare認証設定
- [ ] Cloudflare APIトークン作成
  - 必要な権限: Zone Read/Write, DNS Edit, Page Write
- [ ] GitHub Secrets設定
  - `CLOUDFLARE_API_TOKEN`, `CLOUDFLARE_ACCOUNT_ID`
- [ ] 環境変数設定: ローカル開発環境用

#### ⬜ タスク 3: CI/CD基本パイプライン作成
- [ ] GitHub Actions基本ワークフロー作成
- [ ] Terraform Planワークフロー作成（PR時自動実行）
- [ ] セキュリティスキャンワークフロー作成

### 🛡️ **フェーズ 2: DNSとドメイン設定**

#### ⬜ タスク 4: ゾーンとドメイン設定
- [ ] Terraformモジュール: `modules/dns`
- [ ] Cloudflareゾーン追加: `kenken-pose-est.com`
- [ ] DNSレコード基本設定:
  - Aレコード: `@` → Cloudflare Pages IP
  - CNAMEレコード: `www` → Cloudflare Pages
- [ ] SSL/TLS設定: フル（strict）モード
- [ ] DNSSEC有効化

#### ⬜ タスク 5: 環境別DNS設定
- [ ] 開発環境DNS: `dev.kenken-pose-est.com`
- [ ] ステージング環境DNS: `staging.kenken-pose-est.com`
- [ ] プレビュー環境DNS: ブランチ名ベースの自動生成
- [ ] APIサブドメイン: `api` → GCP Cloud Run（変数で管理）

### 🌐 **フェーズ 3: Cloudflare Pages設定**

#### ⬜ タスク 6: Pagesプロジェクト設定
- [ ] Terraformモジュール: `modules/pages`
- [ ] Cloudflare Pagesプロジェクト作成: `pose-est-frontend`
- [ ] ソース連携: GitHubリポジトリ接続
- [ ] ビルド設定:
  - ビルドコマンド: `npm run build`
  - 出力ディレクトリ: `dist`
  - Nodeバージョン: 18
- [ ] 環境変数設定: APIエンドポイントURLなど

#### ⬜ タスク 7: カスタムドメイン設定
- [ ] プライマリドメイン: `kenken-pose-est.com`
- [ ] エイリアスドメイン: `www.kenken-pose-est.com`
- [ ] HTTPS強制: 自動的にHTTPSへリダイレクト
- [ ] 証明書管理: 自動SSL証明書発行

#### ⬜ タスク 8: ルーティングとヘッダー設定
- [ ] `_routes.json` 設定: SPA用キャッチオールルート
- [ ] `_headers.json` 設定: セキュリティヘッダー追加
- [ ] `_redirects.json` 設定: カスタムリダイレクト
- [ ] キャッシュポリシー: 静的アセットの最適化

### 🔒 **フェーズ 4: セキュリティ設定**

#### ⬜ タスク 9: WAF設定
- [ ] Terraformモジュール: `modules/security`
- [ ] マネージドWAFルールセットの有効化:
  - Cloudflare Managed Ruleset
  - OWASP Core Ruleset
- [ ] カスタムファイアウォールルール:
  - APIエンドポイント保護
  - 管理者パス保護
- [ ] ボット対策: ボットファイトモード有効化

#### ⬜ タスク 10: レート制限設定
- [ ] APIエンドポイントのレート制限:
  - `api.kenken-pose-est.com/*` への制限
  - IPベースの制限設定
  - 異常トラフィックのブロック
- [ ] ブルートフォース対策: ログイン試行回数制限

#### ⬜ タスク 11: セキュリティヘッダーと暗号化
- [ ] セキュリティヘッダー設定:
  - HSTS (HTTP Strict Transport Security)
  - X-Content-Type-Options
  - X-Frame-Options
  - CSP (Content Security Policy) - 慎重に設定
- [ ] 暗号化設定: TLS 1.3の強制

### ⚡ **フェーズ 5: パフォーマンス最適化**

#### ⬜ タスク 12: CDNとキャッシュ設定
- [ ] キャッシュレベル設定: 標準的なキャッシュ動作
- [ ] ブラウザキャッシュTTL: 静的アセットの長期キャッシュ
- [ ] キャッシュキーカスタマイズ: クエリパラメータの扱い
- [ ] オリジンキャッシュ制御: GCP側との整合性確保

#### ⬜ タスク 13: 画像とアセット最適化
- [ ] 画像最適化: Polishの有効化
- [ ] WebP変換: 自動的な次世代フォーマット配信
- [ ] ミラーミニフィケーション: CSS/JSの自動圧縮
- [ ] 早期ヒンティング: 重要なリソースの事前読み込み

#### ⬜ タスク 14: ネットワーク最適化
- [ ] HTTP/2とHTTP/3の有効化
- [ ] 0-RTT接続リサム: QUICプロトコルの活用
- [ ] Argo Smart Routing: 最適なネットワーク経路の選択
- [ ] WebSocket最適化: リアルタイム通信の効率化

### 📊 **フェーズ 6: 監視と分析**

#### ⬜ タスク 15: アナリティクス設定
- [ ] Terraformモジュール: `modules/monitoring`
- [ ] Web Analytics有効化: プライバシー重視の分析
- [ ] カスタムメトリクス: ビジネスKPIの追跡
- [ ] トラフィック分析ダッシュボードの設定

#### ⬜ タスク 16: ユーザー体験監視
- [ ] Browser Insights有効化: 実際のユーザーメトリクス
- [ ] コアウェブバイタル監視: LCP, FID, CLS
- [ ] 合成モニタリング: 定期的なページ読み込みテスト
- [ ] リアルユーザーモニタリング (RUM): 詳細なパフォーマンスデータ

#### ⬜ タスク 17: アラート設定
- [ ] 帯域幅アラート: 異常なトラフィック増加
- [ ] セキュリティアラート: WAFブロック数の急増
- [ ] パフォーマンスアラート: ページ読み込み時間の悪化
- [ ] 通知チャンネル設定: Slack/Email通知

### 🔄 **フェーズ 7: CI/CDパイプライン完成**

#### ⬜ タスク 18: フロントエンドCI/CDパイプライン
- [ ] GitHub Actionsワークフロー: `frontend-deploy.yml`
- [ ] ビルドステージ:
  - 依存関係インストール
  - テスト実行（Vitest）
  - ビルド最適化
- [ ] デプロイステージ:
  - Cloudflare Pagesデプロイ
  - 環境別設定注入
- [ ] 検証ステージ:
  - 本番環境E2Eテスト
  - パフォーマンステスト

#### ⬜ タスク 19: インフラCI/CDパイプライン
- [ ] GitHub Actionsワークフロー: `terraform-apply.yml`
- [ ] Planステージ:
  - Terraform初期化
  - 計画実行と出力
  - セキュリティスキャン（Checkov）
- [ ] Applyステージ（承認ベース）:
  - 環境別Terraform適用
  - 状態ファイル管理
- [ ] 検証ステージ:
  - DNS設定確認
  - SSL証明書検証

#### ⬜ タスク 20: プレビュー環境自動化
- [ ] ブランチベースのプレビュー環境自動作成
- [ ] PRごとの一時的なドメイン割り当て
- [ ] プレビュー環境の自動クリーンアップ
- [ ] プレビュー環境のセキュリティ設定

### 🧪 **フェーズ 8: テストと検証**

#### ⬜ タスク 21: 機能テスト
- [ ] DNS解決テスト: すべてのドメインの正しい解決
- [ ] SSL/TLSテスト: 証明書の有効性と設定
- [ ] フロントエンド配信テスト: 全環境でのアクセス確認
- [ ] API連携テスト: GCPバックエンドとの通信確認

#### ⬜ タスク 22: セキュリティテスト
- [ ] WAFルールテスト: 攻撃パターンのブロック確認
- [ ] レート制限テスト: 過剰リクエストの制限確認
- [ ] セキュリティヘッダーテスト: 適切なヘッダー設定確認
- [ ] SSL/TLS設定テスト: 暗号化強度の確認

#### ⬜ タスク 23: パフォーマンステスト
- [ ] キャッシュ効果テスト: CDNキャッシュの動作確認
- [ ] グローバルアクセステスト: 各地域からのアクセス速度
- [ ] 負荷テスト: 大量トラフィックへの対応確認
- [ ] フェイルオーバーテスト: 障害時の動作確認

### 📚 **フェーズ 9: ドキュメントと運用準備**

#### ⬜ タスク 24: 技術ドキュメント
- [ ] アーキテクチャ図作成（Cloudflare部分）
- [ ] デプロイ手順書作成
- [ ] トラブルシューティングガイド
- [ ] セキュリティ設定ガイド

#### ⬜ タスク 25: 運用ドキュメント
- [ ] 監視ダッシュボード説明書
- [ ] アラート対応手順
- [ ] DNS変更手順
- [ ] 証明書更新手順

#### ⬜ タスク 26: GCP連携ドキュメント
- [ ] API連携仕様書
- [ ] 環境変数連携手順
- [ ] 障害時の連携手順
- [ ] バージョン互換性マトリックス

#### ⬜ タスク 27: 最終検証と本番移行
- [ ] 本番環境最終テスト
- [ ] 移行計画作成（段階的ロールアウト）
- [ ] ロールバック計画作成
- [ ] 本番移行実行と検証

---

## 各フェーズ完了基準

1. **コード品質**: Terraform fmt, tflint, checkov でエラーなし
2. **テスト**: すべての機能テストが正常に完了
3. **ドキュメント**: 必要なドキュメントが作成済み
4. **セキュリティ**: セキュリティスキャンで重大な脆弱性なし
5. **GCP連携**: API連携が正常に動作

## 重要注意事項

1. **状態ファイル管理**: 
   - 開発/ステージング/本番で状態ファイルを分離
   - 適切なバックエンド設定（推奨: Cloudflare R2またはTerraform Cloud）

2. **シークレット管理**:
   - APIトークンはGitHub Secretsで管理
   - Terraform変数で直接シークレットを扱わない

3. **GCP連携**:
   - API DNSレコードの値はGCP側の完了を待って設定
   - 定期的な接続テストの実施

4. **コスト管理**:
   - 常にFreeプランの範囲内で設計
   - 帯域幅とビルド回数の監視
